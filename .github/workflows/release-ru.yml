# Release Workflow for repo_updater (ru)
# Triggered by version tags (v*)
#
# Creates GitHub releases with checksums and notifies downstream package managers

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v1.3.0). Leave empty to use current ref.'
        required: false

# Only write permission needed for creating releases
permissions:
  contents: write

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: Create Release with Checksums
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
            if [[ -z "$TAG" ]]; then
              echo "::error::Tag input is required for manual dispatch"
              exit 1
            fi
            # Verify the tag exists
            if ! git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
              echo "::error::Tag $TAG does not exist"
              exit 1
            fi
            VERSION="${TAG#v}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Verify script version matches tag
        run: |
          script_version=$(grep -m1 'VERSION=' ru | cut -d'"' -f2)
          tag_version="${{ steps.version.outputs.version }}"

          if [[ "$script_version" != "$tag_version" ]]; then
            echo "::error::Script VERSION ($script_version) does not match tag ($tag_version)"
            echo "Please update VERSION in ru before tagging"
            exit 1
          fi

          echo "Version check passed: $tag_version"

      - name: Verify VERSION file matches tag
        run: |
          if [[ -f VERSION ]]; then
            file_version=$(cat VERSION)
            tag_version="${{ steps.version.outputs.version }}"

            if [[ "$file_version" != "$tag_version" ]]; then
              echo "::error::VERSION file ($file_version) does not match tag ($tag_version)"
              exit 1
            fi
          fi

      - name: Verify tag is on main branch
        run: |
          git fetch origin main
          TAG_SHA="$GITHUB_SHA"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG_SHA=$(git rev-parse "refs/tags/v${{ steps.version.outputs.version }}")
          fi
          if ! git merge-base --is-ancestor "$TAG_SHA" origin/main; then
            echo "::error::Tag commit ($TAG_SHA) is not reachable from main"
            exit 1
          fi
          echo "Tag verified: commit $TAG_SHA is on main"

      - name: Compute SHA256 checksums
        run: |
          echo "Computing checksums..."
          sha256sum ru install.sh > checksums.txt
          cat checksums.txt

      - name: Create individual checksum files
        run: |
          sha256sum ru | awk '{print $1}' > ru.sha256
          sha256sum install.sh | awk '{print $1}' > install.sh.sha256

      - name: Generate release notes
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          {
            echo "## Installation"
            echo ""
            echo '```bash'
            echo "curl -fsSL https://raw.githubusercontent.com/joyshmitz/repo_updater/main/install.sh | bash"
            echo '```'
            echo ""
            echo "## Verify Installation (Optional)"
            echo ""
            echo "After downloading, verify the checksum:"
            echo ""
            echo '```bash'
            echo "# Verify ru script"
            echo "echo \"\$(curl -fsSL https://github.com/joyshmitz/repo_updater/releases/download/v${RELEASE_VERSION}/ru.sha256)  ru\" | sha256sum -c -"
            echo '```'
            echo ""
            echo "## Checksums"
            echo ""
            echo "SHA256 checksums for this release are attached as \`checksums.txt\`."
          } > release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ru v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            ru
            install.sh
            checksums.txt
            ru.sha256
            install.sh.sha256
          generate_release_notes: true
          append_body: true
          fail_on_unmatched_files: true

    outputs:
      version: ${{ steps.version.outputs.version }}

  # ==========================================================================
  # Notify Package Managers to Update
  # ==========================================================================
  notify-homebrew-tap:
    name: Notify Homebrew Tap
    runs-on: ubuntu-latest
    needs: release
    # Dormant: dispatches to upstream (Dicklesworthstone/homebrew-tap).
    # Do NOT enable until repository target is updated to our own tap.
    if: ${{ vars.HOMEBREW_TAP_ENABLED == 'true' }}
    steps:
      - name: Check for dispatch token
        id: check_token
        run: |
          if [[ -z "${{ secrets.HOMEBREW_TAP_TOKEN }}" ]]; then
            echo "::warning::HOMEBREW_TAP_TOKEN secret not configured - skipping Homebrew notification"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger formula update
        if: steps.check_token.outputs.skip != 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: Dicklesworthstone/homebrew-tap
          event-type: formula-update
          client-payload: |
            {
              "tool": "ru",
              "version": "${{ needs.release.outputs.version }}",
              "sha": "${{ github.sha }}",
              "actor": "${{ github.actor }}"
            }

      - name: Log dispatch
        if: steps.check_token.outputs.skip != 'true'
        run: |
          echo "Dispatched formula-update event to homebrew-tap"
          echo "  Tool: ru"
          echo "  Version: ${{ needs.release.outputs.version }}"
